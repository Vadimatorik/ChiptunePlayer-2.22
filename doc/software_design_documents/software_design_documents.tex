\documentclass[a4paper, 12pt]{article}
\usepackage[left=25mm, top=20mm, right=10mm, bottom=20mm, nohead, nofoot]{geometry}

\usepackage [warn]{mathtext}				% Чтобы можно было использовать русские буквы в формулах, 
											% но в случае использования предупреждать об этом
\usepackage{placeins}
\usepackage [T2A]{fontenc}		            % Выбор внутренней TEX−кодировки.
\usepackage [utf8]{inputenc}		        % Выбор кодовой страницы документа.
\usepackage [english, russian]{babel}		% Выбор языка документа.
\usepackage{amsmath}						% Математика.
\usepackage{svg}
\usepackage{graphicx}						% Картинки.
\usepackage{xcolor}
\usepackage{indentfirst}					% Красная строка в начале абзаца.
\usepackage{svg}

											%Настраиваем гиппер-ссылки.
\usepackage[pdfpagelayout=OneColumn, 		% pdf отображается как сплошная полоса из A4.
			colorlinks=true,				% Не нужно рисовать рамку вокруг ссылок, но при этом идет выделение цветом.
			linkcolor=black					% Используем черный цвет для обозначения гиппер ссылок в оглавлении.					
]{hyperref} 

\begin{document}

\title {ОПИСАНИЕ ПРОГРАММНОГО ОБЕСПЕЧЕНИЯ CHIPTUNE PLAYER 2.22}
\author {Автор: Дерябкин Вадим}
\date {2018}
\maketitle
\clearpage

\tableofcontents							% Оглавление.
\clearpage									% Первая глава должна идти начиная со следущей страницы.

\section{Принятые соглашения об именах в проекте}
\subsection{Именование файлов}
В проекте каждому файлу .cpp соответствует файл .h.

Файлы именуются по по шаблону:
\begin{verbatim}
ayplayer_name.cpp
ayplayer_name.h
\end{verbatim}

\textbf{name} - имя файла.\\

\textbf{Пример}: \textit{core} из описания эквивалентно \textit{ayplayer\_core.cpp} и \textit{ayplayer\_core.h} в древе проекта.

\subsection{Правила формирования имен глобальных объектов}
В коде программы именование глобальных структур, передаваемых конструктору глобального объекта производится по шаблону:
\begin{verbatim}ayplayer_name_cfg\end{verbatim}

\textbf{name} - имя объекта, который будет инициализирован при помощи данной структуры.\\

\textbf{Пример}: \textit{lcd\_res\_pin} из описания эквивалентно \textit{ayplayer\_lcd\_res\_pin\_cfg} в коде.\\

В коде программы именование глобальных объектов производится по шаблону:
\begin{verbatim}ayplayer_name_obj\end{verbatim}

\textbf{name} - имя объекта.\\

\textbf{Пример}: \textit{lcd\_res\_pin} из описания эквивалентно \textit{ayplayer\_lcd\_res\_pin\_obj} в коде.


\section{Глобальные объекты}

\subsection{Объект глобального порта}
\label{gb}
\noindentИмя объекта: \textbf{gp}\\
\noindentЭкземпляр класса: \textbf{global\_port}\\
\noindentРасположение: user\_code -> mk\_hardware -> port\\

Данный объект агрегирует внутри себя все используемые выводы микроконтроллера, предоставляя возможность инициализации всех перечисленных в структуре инициализации выводов одной командой.

Включает в себя следующие выводы, разбитые по группам в соответствии с назначением:
\begin{itemize}
	\item Аналоговые входы (каналы ADC):
	\begin{itemize}
		\item \textbf{adc\_bat} - подключен к VDD аккумулятора через резистивный делитель 1:1 (делит напряжение пополам).
		\item \textbf{adc\_right} - подключен к входу правого аудио канала усилителя. 
		\item \textbf{adc\_left} - подключен к входу левого аудио канала усилителя. 
	\end{itemize}
	
	\item Качелька громкости:
	\begin{itemize}
		\item \textbf{button\_inc} - подключен к клавише увеличения громкости.
		\item \textbf{button\_dec} - подключен к клавише уменьшения громкости.
	\end{itemize}

	\item MIDI:
	\begin{itemize}
		\item \textbf{midi\_uart\_rx} - подключен к гальванически развязанному входу (прием от мастера) MIDI-интерфейса.
	\end{itemize}

	\item Управление LCD:
	\begin{itemize}
		\item \textbf{lcd\_clk} - подключен к выводу приема тактового сигнала LCD.
		\item \textbf{lcd\_pwm} - подключен к транзистору, через который подключен к LCD подсветке (светодиодам). Служит для формирования ШИМ-сигнала (яркости) подсветки.
		\item \textbf{lcd\_mosi} - подключен к выводу приема данных LCD.
		\item \textbf{lcd\_res} - подключен к выводу сброса LCD. Инвертированный.
		\item \textbf{lcd\_dc} - подключен к выводу выбора интерпретации пакетов <<Команда/Данные>>, принимаемых LCD по SPI.
		\item \textbf{lcd\_cs} - подключен к выводу выбора LCD в качестве приемника на шине SPI1.
	\end{itemize}

	\item Карта micro-sd пользователя (sd1):
	\begin{itemize}
		\item \textbf{sd1\_push} - подключен к защелке разъема карты sd1.
		\item \textbf{sd1\_smd} - подключен к выводу выбора <<команда/ответ>> sd1.
		\item \textbf{sd1\_d0} - подключен к шине данных sd1.
		\item \textbf{sd1\_d1} - подключен к шине данных sd1.
		\item \textbf{sd1\_d2} - подключен к шине данных sd1.
		\item \textbf{sd1\_d3} - подключен к шине данных sd1.
		\item \textbf{sd1\_clk} - подключен к выводу тактового сигнала sd1.
	\end{itemize}	
	
	\item USB 2.0:
	\begin{itemize}
		\item \textbf{otg\_fs\_vbus} - подключен к контакту VCC USB-разъема.
		\item \textbf{usb\_dm} - подключен к контакту DM USB-разъема.
		\item \textbf{usb\_dp} - подключен к контакту DP USB-разъема.
	\end{itemize}

	\item Звуковые сопроцессоры:
	\begin{itemize}
		\item \textbf{bdir} - подключен к выводам выбора направления (чтение/запись) параллельной шины обоих чипов.
		\item \textbf{ay\_1\_res} - подключен к транзистору, зажимающему контакт reset первого звукового сопроцессора на землю (сбрасывает) (DIP28).
		\item \textbf{ay\_2\_res} - подключен к транзистору, зажимающему контакт reset второго звукового сопроцессора на землю (сбрасывает) (DIP40).
		\item \textbf{bc1} - подключен к выводам-защелкам приема данных из параллельной шины обоих чипов.
		\item \textbf{ay\_clk} - подключен к входу приема тактового сигнала обоих чипов.
	\end{itemize}
		
	\item SPI3 (эмуляция параллельной шины для музыкальных сопроцессоров и векторной клавиатуры, управление цифровыми потенциометрами):
	\begin{itemize}
		\item \textbf{spi\_audio\_clk} - подключен к выводам тактового сигнала сдвиговых регистров и цифровых потенциометров.
		\item \textbf{spi\_audio\_tx} - подключен к выводам приема данных сдвиговых регистров и цифровых потенциометров.
	\end{itemize}

	\item Цифровые потенциометры:
	\begin{itemize}
		\item \textbf{shdn} - подключен к выводу перевода каналов цифровых потенциометров в Z состояние.
		\item \textbf{spi\_audio\_st\_reg} - подключен к выводам-защелкам внутренних сдвиговых регистров цифровых потенциометров.
		\item \textbf{dp\_cs} - подключен к выводу выбора цифровых потенциометров в качестве приемников на шине SPI3.
	\end{itemize}

	\item Векторная клавиатура:
	\begin{itemize}
		\item \textbf{button\_in} - соединенный с общим контактом векторной клавиатуры.
	\end{itemize}

	\item Программирование и отладка:
	\begin{itemize}
		\item \textbf{swd\_io} - подключен к выводу SWDIO разъема программирования.
		\item \textbf{swd\_clk} - подключен к выводу SWDCLK разъема программирования.
	\end{itemize}

	\item Питание:
	\begin{itemize}
		\item \textbf{pwr\_5\_v\_on} - подключен к транзистору, открывающему подачу 5 вольт на плату.
		\item \textbf{pwr\_on} - подключен к транзистору, разрешающему подачу входного напряжения на плату.
		\item \textbf{tp\_st} - подключен к контроллеру заряда аккумулятора (обратная связь).
		\item \textbf{tp\_ch} - подключен к контроллеру заряда аккумулятора (обратная связь).
		\item \textbf{chip\_1\_pwr\_on} - подключен к транзистору, открывающему подачу питания на первый чип.
		\item \textbf{chip\_2\_pwr\_on} - подключен к транзистору, открывающему подачу питания на второй чип.
	\end{itemize}
	
	\item Карта micro-sd системы (sd2):
	\begin{itemize}
		\item \textbf{sd2\_rx} - подключен к выводу вывода данных из sd2 в микроконтроллер.
		\item \textbf{sd2\_tx} - подключен к выводу приема данных sd2 из микроконтроллера.
		\item \textbf{sd2\_clk} -подключен к выводу приема тактового сигнала sd2.
		\item \textbf{sd2\_cs} - подключен к выводу выбора системной карты памяти в качестве приемника на шине SPI2.
		\item \textbf{sd2\_push} - подключен к защелке разъема micro-sd карты системы.
	\end{itemize}
	
	\item Отладочный/Загрузочный UART:
	\begin{itemize}
		\item \textbf{boot\_tx} - подключен к контакту разъема, соединяемому с RX выводом UART-TTL преобразователем.
		\item \textbf{boot\_rx} - подключен к контакту разъема, соединяемому с TX выводом UART-TTL преобразователем.
	\end{itemize}
\end{itemize}

\subsection{Программно управляемые порты ввода-вывода}
Все порты ввода-вывода являются экземплярами класса \textbf{pin}. Расположенны в user\_code -> mk\_hardware -> port. Описание назначения портов ввода-вывода можно найти в секции~\ref{gb}.
\begin{itemize}
	\item Качелька громкости: \textbf{button\_inc}, \textbf{button\_dec}.
	\item Управление LCD: \textbf{lcd\_res}, \textbf{lcd\_dc}, \textbf{lcd\_cs}.
	\item Карта micro-sd пользователя (sd1): \textbf{sd1\_push}.
	\item Звуковые сопроцессоры: \textbf{bdir}, \textbf{ay\_1\_res}, \textbf{ay\_2\_res}, \textbf{bc1}.
	\item Цифровые потенциометры: \textbf{shdn}, \textbf{spi\_audio\_st\_reg}, \textbf{dp\_cs}
	\item Векторная клавиатура: \textbf{button\_in}.
	\item Питание: \textbf{pwr\_5\_v\_on}, \textbf{pwr\_on}, \textbf{tp\_st}, \textbf{tp\_ch}, \textbf{chip\_1\_pwr\_on}, \textbf{chip\_2\_pwr\_on}.
	\item Карта micro-sd системы (sd2): \textbf{sd2\_cs}, \textbf{sd2\_push}.
\end{itemize}

\section{Используемые в проекте субмодули}
\begin{itemize}
	\item \textbf{module\_button} - содержит классы для работы с клавиатурами разных типов.
	\item \textbf{module\_chiptune} - содержит классы для работы с различным музыкальными сопроцессорами.
	\item \textbf{module\_digital\_potentiometer} - содержит классы для работы с различными цифровыми потенциометрами.
	\item \textbf{module\_fatfs\_by\_chan} - FatFs от ChaN-а.
	\item \textbf{module\_freertos\_for\_stm32f2} - FreeRTOS собранная для stm32f2 серии. Со статическим распределением оперативной памяти.
	\item \textbf{module\_fsm} - ядро конечного автомата.
	\item \textbf{module\_makise\_gui} - библиотека графического интерфейса.
	\item \textbf{module\_math} - различные математические алгоритмы.
	\item \textbf{module\_mc\_hardware\_interfaces} - абстрактные интерфейсы для работы с периферией микроконтроллера (является зависимостью большинства имеющихся в проекте субмодулей).
	\item \textbf{module\_microsd\_low\_level\_driver} - низкоуровневый драйвер работы с microsd картами по SPI и SDIO. 
	\item \textbf{module\_mono\_lcd\_lib} - низкоуровневые драйвера дисплеев.
	\item \textbf{module\_run\_time\_logger} - системный самописец. Является зависимостью многих модулей.
	\item \textbf{module\_shift\_register} - содержит классы для работы со сдвиговыми регистрами.
	\item \textbf{module\_stm32f2\_low\_level\_by\_st} - низкоуровневая библиотека для работы с периферией микроконтроллера (реализует интерфейсы module\_mc\_hardware\_interfaces).
	\item \textbf{module\_system\_dummy} - системные функции для компиляции C и CPP кода (стандартные callback-и).
\end{itemize}

\section{Начальная инициализация до запуска планировщика операционной системы}
\subsection{До запуска main}
Выполнение начинается со startup-файла, находящегося в по пути:

module\_stm32f2\_low\_level\_by\_st -> CMSIS -> Device -> Source -> startup\_stm32f205xx.s

Startup:
\begin{enumerate}
	\item Устанавливает вершину steck-а
	\item Заполняет Data область RAM значениями по умолчанию из Flash. 
	\item Очищает BSS область RAM (заполняет нулями).
	\item Вызывает метод SystemInit, расположенному в module\_stm32f2\_low\_level\_by\_st -> CMSIS -> Device -> Source -> system\_stm32f2xx.c, сбрасывающий RCC и устанавливающий смещение таблицы вектора прерываний на начало Flash (по умолчанию).
	\item Вызывает конструкторы всех глобальных объектов в проекте*. 
	\item Вызывается main.
\end{enumerate}
*Поскольку очередность вызова конструкторов не определена, то предполагается, что конструктор инициализирует только поля своего объекта и не обращается к другим объектам (даже если имеются указатели на них). Так же конструкторы не должны обращаться к реальной аппаратной периферии. В случае, если инициализация объекта предполагает использования аппаратной периферии (например, инициализация LCD), то в классе объекта должен быть метод \textbf{init}, который вызывается уже в нужном порядке специальным методом после вызова main.

\subsection{Сопутствующие методы}
Используемые при компиляции библиотеки нуждаются в реализации пользователем необходимых callback-ов. Файл, содержащий их находится в отдельном \textbf{submodule module\_\-system\_\-dummy} и имеет название \textbf{cpp\_system\_calls}.

В файле реализованы следующие callback-и:
\begin{enumerate}
	\item \textbf{\_exit} - выход из программы. Вызывается программная перезагрузка.
	\item \textbf{\_abort} - принудительная перезагрузка. Так же вызывается программный сброс.
	\item \textbf{\_kill} - <<убийство>> процесса. Заглушка.
	\item \textbf{\_close} - закрытие файла. Заглушка.
	\item \textbf{\_write} - вывод в системный терминал. Заглушка.
	\item \textbf{\_read} - чтение из системного терминала. Заглушка.
	\item \textbf{\_fstat} - возвращение типа <<файла>>. Возвращается тип <<Символно-ореинтированный <<файл>>.>>.
	\item \textbf{\_lseek} - установка позиции в файле. Заглушка.
	\item \textbf{\_isatty} - запрос уточнения, является ли файл терминалом. Возвращается <<Да>>.
	\item \textbf{\_getpid} - Возвращает ID процесса. Заглушка.
	\item \textbf{\_execve} - Передача управления новому процессу. Процессов нет => возвращаем ошибку.
	\item \textbf{\_fork} - Создание нового процесса. Не поддерживается.
	\item \textbf{\_times} - Временная информация о процессе. Не используется.
	\item \textbf{\_unlink} - Удаление имени файла. Не используется.
	\item \textbf{\_wait} - Ожидание дочерних процессов. Не используется.
	\item \textbf{\_sbrk} - Проверяем, что наши данные ( которые malloc и прочие могут попробовать запросить ) не наложатся на стек.
\end{enumerate}

\subsection{Инициализация аппаратной периферии контроллера}
В методе \textbf{main}, расположенном в \textit{user\_\-code -> main} вызывается метод \textbf{ayplayer\_\-mc\_\-hardware}, содержащий в себе инициализацию всех аппаратных блоков периферии микроконтроллера, расположенный в \textit{user\_\-code -> mk\_\-hardware -> ayplayer\_\-hardware}. 

Метод включает в себя вызов методов инициализации следующих блоков:
\begin{enumerate}
	\item Сторожевой таймер (WDT).
	\item Глобальный порт и объекты программно управляемых выводов с установкой состояния по умолчанию (GPIO)
	\item Аналогоцифровой преобразователь (ADC)
	\item Шины последовательной передачи данных (SPI)
	\item Таймеры (TIMER)
	\item Шины последовательной асинхронной приемопередачи UART
\end{enumerate}
	
\paragraph{Сторожевой таймер (WDT)}~\

Метод инициализации \textbf{ayplayer\_wdt\_init} расположен в \textit{user\_\-code -> mk\_\-hardware -> ayplayer\_wdt}. Метод вызывает метод \textbf{init} глобального объекта \textbf{wdt}, который запускает обратный счетчик со значением \textit{startup\_time\_ms}, взятым из структуры инициализации. За это время должна пройти вся цепочка инициализации. Иначе микроконтроллер будет перезагружен.

\end{document}
